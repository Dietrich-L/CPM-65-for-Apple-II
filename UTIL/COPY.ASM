;COPY.ASM  Apple II Version
;(c) by D. Lausberg  1995

;Kopierprogramm fr 1 und 2 Disk Drives
;Aufruf   COPY d:filename.ext d: /switch
;Switches   Y   Y/N Abfrage nach jedem Filenamen

;V1.0	20.03.95
;V1.1	31.03.95	no disc change on C:
;V1.2	31.12.95	no disc change on C: and above
;V1.3	11.04.02	sector BIOS version
;V1.4	30.04.21	4 Floppies

;Parameters

DIRPNT	= $0		;DIR POINTER
DIRPNT1	= $1		;AUXILIARY DIR POINTER
CNT	= $2		;COUNTER
SDRIVE	= $3		;SOURCE DRIVE FOR SELDSK
SD_ASC	= $4		;DRIVE CHARACTER
DDRIVE	= $5		;DESTINATION DRIVE
DD_ASC	= $6
F_CNT	= $7		;FILE COUNTER
1PAGE	= $8		;1. PAGE OF HEAP
LPAGE	= $9		;LAST PAGE OF HEAP
S_CNT	= $A		;SOURCE COUNTER
D_CNT	= $B		;DESTINATION COUNTER
FLAG	= $C
SWITCH	= $D
ERRNO	= $E
PNT	= $F
PAGES	= $10		;nr of pages to buffer files

BUFPNT	= $12		;FILENAME BUFFER POINTER
S_PNT	= $14		;SOURCE FILENAME BUFFER POINTER

CCPV	= $DE
BDOS	= $F0
FCB1	= $F6
FCB2	= $F4
DIRBUF	= $FC
DMA	= $FE

TPA	= $800

;CONSTANTS

DIR_EXT	= $0C

;ERROR CODES

ABORT	= $81
NOSWITCH = $82
NOFILENAME = $83
NO_FILE	= $84
FILE_TOO_LONG = $85
READY	= $9E
NOCOPY	= $9F

EOF	= $D7
DOUBLE	= $DC
NOTFND	= $DD

;BDOS COMMANDS

CONIN	= $1
CONOUT	= $2
STROUT	= $9
SELDRV	= $E
OPEN	= $F
CLOSE	= $10
FIRST	= $11
NEXT	= $12
RDSEQ	= $14
WDSEQ	= $15
CREATE	= $16
GETDRV	= $19
BIOSC	= $1A

;BIOS COMMANDS

_CHRIN	= 3

;CONTROL CHARACTERS

CR	= $D
LF	= $A
EOT	= $0
SP	= $20

;--------------------------------------------------------

	ORG TPA


COPY	LDA #STARTM		;DISPLAY STARTUP MESSAGE
	LDY #STARTM/256
	JSR PRTSTR
	JSR INIT		;INITIALIZE
	BCS COPYX
	JSR GETFIL
	BCS COPYX
	LDY BUFPNT+1
	INY
	STY 1PAGE		;SET 1. PAGE OF HEAP
	LDA BDOS+2
	STA LPAGE		;SET LAST PAGE
	SEC
	SBC 1PAGE
	STA PAGES		;set nr. of pages
	JSR RESP		;RESET BUFFER POINTERS
COPY1	JSR RDFIL		;READ FILES
	BCS COPYX
	JSR WRFIL
	BCC COPY1
	CMP #READY
	BEQ COPY2
COPYX	JSR ERROR
COPY2	LDA #ENDM
	LDY #ENDM/256
	JSR PRTSTR
	LDA SDRIVE
	LDX #SELDRV
	JSR BDOS
	LDX #0
	JMP BDOS

;-----  SUBROUTINES  ----------

RDFIL	JSR RESDMA		;READ FILES TO COPY TILL EOM
	JSR CH_SD		;GET SOURCE DISK
	BCS RDFILX
RDFIL1	LDA #READING
	LDY #READING/256
	JSR PRTSTR
RDFIL8	JSR SETSFCB		;SET FCB WITH SOURCE FILENAME
	JSR PRTFCB		;print filename
RDFIL3	LDX #OPEN		;OPEN FILE
	JSR BDOS
	BCS RDFIL2
	LDA #0
	STA CNT
	LDA DMA+1
	LDY #14			;SAVE START PAGE
	STA (S_PNT),Y
RDFIL5	LDX #RDSEQ		;READ 1 BLOCK
	JSR BDOS
	BCS RDFIL4
	INC DMA+1
	INC CNT
	LDA DMA+1
	CMP LPAGE
	BCC RDFIL5
	LDA CNT
	CMP PAGES
	BCS RDFIL9
	RTS

RDFIL4	CMP #EOF
	BEQ RDFIL6
	JSR ERROR
	BCC RDFIL5
	RTS

RDFIL6	LDY #12
	LDA CNT
	STA (S_PNT),Y
	INC S_CNT
	LDA S_CNT
	CMP F_CNT
	BEQ RDFIL7
	CLC
	LDA #16			;SET POINTER TO NEXT FILE
	ADC S_PNT
	STA S_PNT
	LDA #0
	ADC S_PNT+1
	STA S_PNT+1
	JMP RDFIL8	

RDFIL2	JSR ERROR
	BCC RDFIL3
RDFILX	RTS

RDFIL7	CLC
	RTS

RDFIL9	LDA #FILE_TOO_LONG
	RTS


WRFIL	JSR CH_DD		;WRITE FILES TO DISK
	BCS WRFILX
	LDA #WRITING
	LDY #WRITING/256
	JSR PRTSTR
WRFIL6	JSR SETDFCB		;SET DESTINATION FCB1
	JSR PRTFCB
	JSR MAKFIL		;MAKE FILE
	BCS WRFIL1
	LDY #12
	LDA (BUFPNT),Y
	STA CNT
	LDY #14
	LDA (BUFPNT),Y
	STA DMA+1
WRFIL3	LDX #WDSEQ
	JSR BDOS
	BCS WRFIL2
	INC DMA+1
	DEC CNT
	BNE WRFIL3
	LDX #CLOSE
	JSR BDOS
	BCS WRFILX
WRFIL7	CLC
	LDA #16
	ADC BUFPNT
	STA BUFPNT
	LDA #0
	ADC BUFPNT+1
	STA BUFPNT+1
	INC D_CNT
	LDA D_CNT
	CMP S_CNT
	BCC WRFIL6
	CMP F_CNT
	BCC WRFILX
	LDA #READY
WRFILX	RTS

WRFIL1	CMP #NOCOPY
	BEQ WRFIL7
	JSR ERROR
	BCC WRFIL6
	RTS

WRFIL2	JSR ERROR
	BCC WRFIL3
	RTS


INIT	LDA #0			;INITIALIZE VARABLES
	LDY #S_PNT+1
INIT11	STA 0,Y
	DEY
	BPL INIT11
	JSR RESP		;RESET BUFFER POINTER
	LDY #0			;SET SOURCE DRIVE
	LDA (FCB1),Y
	BNE INIT6
	LDX #GETDRV		;GET DEFAULT DRIVE
	JSR BDOS
	TAX
	INX
	TXA
INIT6	STA SDRIVE		;SAVE SOURCE DRIVE
	DEC SDRIVE
	ORA #$40
	STA SD_ASC
	LDY #0
	LDA (FCB2),Y		;CHECK FOR DESTINATION DRIVE
	BNE INIT7
	LDA SDRIVE
	TAX
	INX
	TXA
INIT7	STA DDRIVE		;SET DESTINATION DRIVE
	DEC DDRIVE
	ORA #$40
	STA DD_ASC
	CMP SD_ASC
	BNE INIT8
	LDA FLAG
	ORA #$80		;SET DISK CHANGE FLAG
	STA FLAG
INIT8	LDY #0
	LDA (DMA),Y		;CHECK FOR SWITCH
	STA PNT
INIT3	INY
	CPY PNT
	BCS INIT2
	LDA (DMA),Y
	CMP #'/			;SWITCH?
	BNE INIT3
	INY
	CPY PNT
	BCS INIT2
	LDA (DMA),Y		;GET SWITCH
	LDX #0
INIT4	CMP SWTAB,X
	BEQ INIT5
	INX
	INX
	CPX #SWTABX-SWTAB
	BCC INIT4
INIT2	LDA #0
	STA SWITCH
	CLC
	RTS

INIT1	LDA #NOFILENAME
	SEC
	RTS

INIT5	INX
	LDA SWTAB,X
	ORA SWITCH
	STA SWITCH
	CLC
	RTS


CH_SD	LDA SD_ASC
	STA DRIVE
	CMP #'E
	BCS CH_SD1
	BIT FLAG
	BPL CH_SD1
	LDA #SOURCE
	LDY #SOURCE/256
	JSR XCH_DSK		;CHANGE SOURCE DISK
CH_SD1	LDA SDRIVE
	LDX #SELDRV
	JSR BDOS
	BCC CH_SDX
	JSR ERROR
	BCC CH_SD1
CH_SDX	RTS


CH_DD	LDA DD_ASC		;CHANGE DESTINATION DISK
	STA DRIVE
	CMP #'E
	BCS CH_DD2
	BIT FLAG
	BPL CH_DD2
	LDA #DEST
	LDY #DEST/256
	JSR XCH_DSK
CH_DD2	LDA DDRIVE
	LDX #SELDRV
	JSR BDOS
	BCC CH_DDX
	JSR ERROR
	BCC CH_DD2
CH_DDX	RTS


RESP	LDA #BUFFER		;RESET BUFPNT and S_PNT
	STA BUFPNT
	STA S_PNT
	LDA #BUFFER/256
	STA BUFPNT+1
	STA S_PNT+1
	RTS


XCH_DSK	JSR PRTSTR
	LDA #XCHGM
	LDY #XCHGM/256		;INSERT DISK
	JSR PRTSTR
	LDY #_CHRIN		;WAIT FOR KEY
	JSR BIOS
	JSR CRLF
	CLC
	RTS


GETFIL	JSR FCB_CHECK		;GET FILE LIST TO COPY
	LDX #FIRST
	JSR BDOS		;CHECK FOR FILE
	BCC GETFIL1
	JSR ERROR
	BCC GETFIL
	RTS

GETFIL1	STY DIRPNT		;PRINT DIRECTORY ENTRY
	STY DIRPNT1
	TYA
	CLC
	ADC #DIR_EXT
	TAY
	LDA (DIRBUF),Y		;SKIP EXTENSIONS
	BNE GETFIL3
	BIT SWITCH		;CHECK Y/N SWITCH
	BPL GETFIL2
	LDA #' '		;print filename
	JSR PRTCHR
	LDA #8
	JSR PRT
	LDA #'.
	JSR PRTCHR
	LDA #3
	JSR PRT
	LDA #' '
	JSR PRTCHR
	LDA #MESSAGE
	LDY #MESSAGE/256
	JSR PRTSTR
	LDX #CONIN	;GET COMMAND KEY
	JSR BDOS
	AND #$5F	;LOWER --> UPPER CASE
	CMP #'E
	BEQ GETFIL9
	CMP #'Y
	BNE GETFIL5
GETFIL2	LDX #16
GETFIL7	LDY DIRPNT1
	LDA (DIRBUF),Y
	LDY #0
	STA (BUFPNT),Y
	INC DIRPNT1
	INC BUFPNT
	BNE GETFIL6
	INC BUFPNT+1
GETFIL6	DEX
	BNE GETFIL7
	INC F_CNT
	BIT SWITCH		;suppress CRLF
	BPL GETFIL3
GETFIL5	JSR CRLF
GETFIL3	LDX #NEXT
	JSR BDOS
	BCC GETFIL1
	CMP #NOTFND
	BEQ GETFIL9
	SEC
GETFILX	RTS

GETFIL9	LDA F_CNT
	BNE GETFIL8
	LDA #NO_FILE
	SEC
	RTS

GETFIL8	CLC
	RTS


PRT	STA CNT		;GET A CHR'S FROM DIRBUF
PRT1	INC DIRPNT	;AND PRINT THEM
	LDY DIRPNT
	LDA (DIRBUF),Y
	JSR PRTCHR	;PRINT CHR
	DEC CNT
	BNE PRT1
	RTS




	APP COPY.APP
